# Copyright 2025 Marc-Antoine Ruel. All Rights Reserved. Use of this
# source code is governed by a BSD-style license that can be found in the
# LICENSE file.
#
# Dockerfile to create md.base
#
# This is the generic portion of the image which is then specialized for your SSH keys.

# We don't need it to be stuck on old images so just fetch whatever is current latest.
FROM docker.io/debian:stable-slim
# FROM ghcr.io/linuxcontainers/debian-slim:latest

## First phase, setup as root.

ENV DEBIAN_FRONTEND=noninteractive

# Copy all /etc files.
COPY etc/ /etc/

# Copy all /root files.
COPY root/ /root/
# Install tools (as root)
RUN /root/setup/packages.sh
RUN /root/setup/neovim.sh
RUN /root/setup/go.sh


### Second phase, as user

# Create user "user"
RUN useradd -ms /bin/bash user
# Copy all /home/user files.
COPY --chown=user:user home/user/ /home/user/
RUN su user -c "mkdir -p /home/user/.ssh /home/user/.config/git /home/user/.local/share"
RUN chmod 0700 /home/user/.ssh

# Create app directory (as user)
RUN mkdir /app
RUN chown user:user /app
RUN su user -c "git init /app"

# Install tools (as user)
RUN su user -c /home/user/setup/go.sh
RUN su user -c /home/user/setup/nodejs.sh
RUN su user -c /home/user/setup/llm.sh

# Start SSH server by default
CMD ["/root/start.sh"]

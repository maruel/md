# syntax=docker/dockerfile:1.6

# Copyright 2025 Marc-Antoine Ruel. All Rights Reserved. Use of this
# source code is governed by an Apache License, Version 2.0 that can be found
# in the LICENSE file.
#
# Dockerfile to create md.base
#
# This is the generic portion of the image which is then specialized for your SSH keys.

# We don't need it to be stuck on old images so just fetch whatever is current latest.
FROM docker.io/debian:stable AS final
LABEL org.opencontainers.image.licenses=Apache-2.0
# FROM ghcr.io/linuxcontainers/debian-slim:latest

## First phase, setup as root.

ENV DEBIAN_FRONTEND=noninteractive

# Copy all /etc files.
COPY etc/ /etc/

# Copy all /usr files.
COPY usr/ /usr/

# Copy all /root files.
COPY root/ /root/

# Setup measurement tool and version report file
RUN echo "| Step | Command | Duration |" > /var/log/build_timings.md && \
    echo "|---|---|---|" >> /var/log/build_timings.md && \
    touch /var/log/tool_versions.md && \
    chmod 666 /var/log/build_timings.md /var/log/tool_versions.md

# Install tools (as root)
RUN measure_exec.sh "System Packages" /root/setup/1_packages.sh
RUN --mount=type=secret,id=github_token \
	/bin/bash -c 'GITHUB_TOKEN="$(cat /run/secrets/github_token 2>/dev/null || true)" measure_exec.sh "Neovim" /root/setup/2_neovim.sh'
RUN measure_exec.sh "Create User" /root/setup/3_create_user.sh
RUN measure_exec.sh "KVM Setup" /root/setup/4_kvm.sh

# Create app directory
RUN mkdir /app && chown user:user /app

### Second phase, as user

# Copy all /home/user files.
COPY --chown=user:user home/user/ /home/user/

USER user
WORKDIR /app
SHELL ["/bin/bash", "-ilc"]

RUN mkdir -p /home/user/.ssh /home/user/.config/git /home/user/.local/share && \
	chmod 0700 /home/user/.ssh && \
	git init /app

# Install tools (as user)
RUN measure_exec.sh 'Go' /home/user/setup/1_go.sh
RUN measure_exec.sh 'Node.js' /home/user/setup/2_nodejs.sh
RUN measure_exec.sh 'LLM Tools' /home/user/setup/3_llm.sh
RUN measure_exec.sh 'Android SDK' /home/user/setup/4_android.sh
RUN --mount=type=secret,id=github_token \
	GITHUB_TOKEN="$(cat /run/secrets/github_token 2>/dev/null || true)" measure_exec.sh "Rust" /home/user/setup/5_rust.sh
RUN measure_exec.sh 'Python' /home/user/setup/6_python.sh

# Generate tool version report
RUN measure_exec.sh 'Version Report' /home/user/setup/generate_version_report.sh > /var/log/tool_versions.md

USER root
SHELL ["/bin/bash", "-c"]

# Start SSH server by default
CMD ["/root/start.sh"]

# Stage to export reports
FROM scratch AS reports
COPY --from=final /var/log/tool_versions.md /
COPY --from=final /var/log/build_timings.md /
